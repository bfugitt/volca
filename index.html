<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volca Sample Classroom Uploader & Sequencer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .volca-gradient {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
        }
        @keyframes record-pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-active {
            animation: record-pulse 1.5s infinite;
            background-color: #ef4444 !important;
        }
        .step-btn {
            aspect-ratio: 1/1;
            transition: all 0.05s;
        }
        .step-active {
            background-color: #ef4444;
            box-shadow: 0 0 6px #ef4444;
            border-color: transparent;
        }
        .current-step {
            outline: 2px solid #3b82f6;
            outline-offset: 1px;
            z-index: 10;
        }
        /* Tightening the layout for 16 steps */
        .grid-cols-sequencer {
            grid-template-columns: 60px repeat(16, minmax(0, 1fr));
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-2 md:p-4 font-sans">

    <div class="max-w-5xl w-full bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-gray-800">
        <!-- Header -->
        <div class="volca-gradient p-3 text-white border-b-4 border-gray-800 flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold tracking-tighter italic">VOLCA <span class="text-red-500">SAMPLE 2</span></h1>
                <p class="text-[7px] uppercase tracking-[0.3em] opacity-70">4th Grade Music Lab / Pattern Hub</p>
            </div>
            <div id="midi-status" class="text-[9px] bg-gray-900 px-3 py-1 rounded-full border border-gray-600 text-gray-400">
                MIDI: Disconnected
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 divide-y lg:divide-y-0 lg:divide-x divide-gray-200">
            <!-- Left Panel: Sample Studio (1/4 width) -->
            <div class="p-4 space-y-4 lg:col-span-1 bg-gray-50">
                <h2 class="text-[10px] font-black uppercase text-gray-400 tracking-widest">1. Sample Studio</h2>
                
                <div class="space-y-2 bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex gap-2">
                        <button id="record-btn" class="flex-1 bg-gray-800 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 hover:bg-gray-700 transition-all">
                            <span id="record-icon" class="w-2 h-2 bg-red-500 rounded-full"></span>
                            <span id="record-text">Record</span>
                        </button>
                        <button id="play-preview" class="hidden w-10 bg-blue-500 text-white rounded-lg items-center justify-center hover:bg-blue-600 transition-all">
                            â–¶
                        </button>
                    </div>
                    <input type="file" id="audio-file" accept="audio/*" class="block w-full text-[9px] text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-[9px] file:font-bold file:bg-gray-100 file:text-gray-700 hover:file:bg-gray-200">
                </div>

                <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                    <span class="text-[9px] font-bold text-gray-500 uppercase">Volca Slot</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="changeSlot(-1)" class="w-6 h-6 rounded-full bg-gray-200 text-gray-700">-</button>
                        <input type="number" id="slot-number" value="0" min="0" max="99" class="w-8 text-center bg-transparent font-bold text-xs">
                        <button onclick="changeSlot(1)" class="w-6 h-6 rounded-full bg-gray-200 text-gray-700">+</button>
                    </div>
                </div>

                <button id="transfer-btn" class="w-full py-3 rounded-xl bg-red-600 text-white font-black text-xs shadow-[0_3px_0_0_rgba(153,27,27,1)] active:shadow-none active:translate-y-1 transition-all uppercase">
                    Upload Sound
                </button>
                <div id="status" class="text-center text-[9px] font-bold text-gray-400 uppercase">Ready</div>
            </div>

            <!-- Right Panel: Pattern Sequencer (3/4 width) -->
            <div class="p-4 space-y-4 lg:col-span-3">
                <div class="flex justify-between items-center gap-4">
                    <div class="flex items-center gap-4 flex-1">
                        <div class="flex flex-col gap-1 w-32">
                            <label class="text-[9px] font-black text-gray-400 uppercase flex justify-between">
                                Tempo <span id="tempo-val" class="text-gray-800">120 BPM</span>
                            </label>
                            <input type="range" id="tempo-slider" min="40" max="240" value="120" class="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-600">
                        </div>
                        <div class="flex flex-col gap-1 w-24">
                            <label class="text-[9px] font-black text-gray-400 uppercase">Save to Pattern</label>
                            <select id="pattern-slot" class="text-[10px] bg-gray-100 p-1 rounded font-bold border-none focus:ring-0">
                                <option value="1">Pattern 1</option>
                                <option value="2">Pattern 2</option>
                                <option value="3">Pattern 3</option>
                                <option value="4">Pattern 4</option>
                                <option value="5">Pattern 5</option>
                                <option value="6">Pattern 6</option>
                                <option value="7">Pattern 7</option>
                                <option value="8">Pattern 8</option>
                                <option value="9">Pattern 9</option>
                                <option value="10">Pattern 10</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="clear-grid" class="text-[8px] border border-gray-300 px-3 py-1 rounded uppercase font-bold text-gray-500 hover:bg-gray-50">Clear</button>
                        <button id="play-btn" class="bg-green-600 text-white text-[10px] px-6 py-2 rounded-full font-bold uppercase shadow-sm active:scale-95 transition-all">Play MIDI</button>
                    </div>
                </div>

                <!-- Main Sequencer Grid -->
                <div class="bg-gray-100 p-2 rounded-xl border border-gray-200 overflow-hidden">
                    <div id="sequencer-grid" class="grid grid-cols-sequencer gap-1">
                        <!-- Labels and Steps generated by JS -->
                    </div>
                </div>

                <div class="flex items-center justify-between gap-4">
                    <p class="text-[8px] text-gray-400 leading-tight flex-1">
                        <strong>Tips:</strong> Connect USB for <strong>Real-time Play</strong>. <br>Connect Audio Cable to <strong>SYNC IN</strong> for <strong>Permanently Saving</strong> patterns.
                    </p>
                    <button id="pattern-transfer-btn" class="px-5 py-2 rounded-lg bg-gray-800 text-white font-bold text-[10px] uppercase hover:bg-black transition-all shadow-md">
                        Save Pattern to Volca
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let recordedAudioUrl = null;
        let midiOut = null;
        let isPlaying = false;
        let currentStep = 0;
        let tempo = 120;
        let timerId = null;

        const PARTS = 10;
        const STEPS = 16;
        const gridState = Array.from({ length: PARTS }, () => Array(STEPS).fill(0));

        // --- MIDI SETUP ---
        if (navigator.requestMIDIAccess) {
            navigator.requestMIDIAccess().then(onMIDISuccess, () => {
                document.getElementById('midi-status').innerText = "MIDI: Error";
            });
        }

        function onMIDISuccess(midiAccess) {
            const updateOutputs = () => {
                const outputs = Array.from(midiAccess.outputs.values());
                if (outputs.length > 0) {
                    midiOut = outputs[0];
                    document.getElementById('midi-status').innerText = `MIDI: ${midiOut.name}`;
                    document.getElementById('midi-status').className = "text-[9px] bg-gray-900 px-3 py-1 rounded-full border border-gray-600 text-green-500";
                } else {
                    midiOut = null;
                    document.getElementById('midi-status').innerText = "MIDI: Disconnected";
                    document.getElementById('midi-status').className = "text-[9px] bg-gray-900 px-3 py-1 rounded-full border border-gray-600 text-gray-400";
                }
            };
            midiAccess.onstatechange = updateOutputs;
            updateOutputs();
        }

        function sendMidiNote(channel, note) {
            if (!midiOut) return;
            const noteOn = 0x90 + (channel - 1);
            midiOut.send([noteOn, note, 100]);
            setTimeout(() => {
                midiOut.send([0x80 + (channel - 1), note, 0]);
            }, 100);
        }

        // --- SEQUENCER UI ---
        const gridContainer = document.getElementById('sequencer-grid');

        function createGrid() {
            gridContainer.innerHTML = '';
            for (let row = 0; row < PARTS; row++) {
                // Add Label
                const label = document.createElement('div');
                label.className = "text-[8px] font-bold text-gray-400 flex items-center pr-2 uppercase italic truncate";
                label.innerText = `Part ${row + 1}`;
                gridContainer.appendChild(label);

                for (let col = 0; col < STEPS; col++) {
                    const btn = document.createElement('button');
                    const isFour = Math.floor(col / 4) % 2 === 0;
                    btn.className = `step-btn rounded-sm border ${isFour ? 'bg-gray-300 border-gray-400' : 'bg-gray-200 border-gray-300'}`;
                    btn.id = `step-${row}-${col}`;
                    btn.onclick = () => {
                        gridState[row][col] = gridState[row][col] ? 0 : 1;
                        btn.classList.toggle('step-active');
                    };
                    gridContainer.appendChild(btn);
                }
            }
        }
        createGrid();

        // --- TEMPO CONTROL ---
        const tempoSlider = document.getElementById('tempo-slider');
        const tempoVal = document.getElementById('tempo-val');
        tempoSlider.oninput = (e) => {
            tempo = e.target.value;
            tempoVal.innerText = `${tempo} BPM`;
        };

        document.getElementById('clear-grid').onclick = () => {
            for (let r=0; r<PARTS; r++) for (let c=0; c<STEPS; c++) gridState[r][c] = 0;
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('step-active'));
        };

        function playStep() {
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('current-step'));
            
            for (let row = 0; row < PARTS; row++) {
                const btn = document.getElementById(`step-${row}-${currentStep}`);
                btn.classList.add('current-step');
                if (gridState[row][currentStep] === 1) {
                    sendMidiNote(row + 1, 60); 
                }
            }

            currentStep = (currentStep + 1) % STEPS;
            const stepInterval = (60000 / tempo) / 4;
            timerId = setTimeout(playStep, stepInterval);
        }

        document.getElementById('play-btn').addEventListener('click', (e) => {
            isPlaying = !isPlaying;
            if (isPlaying) {
                e.target.innerText = "Stop";
                e.target.className = "bg-red-600 text-white text-[10px] px-6 py-2 rounded-full font-bold uppercase shadow-md active:scale-95";
                currentStep = 0;
                playStep();
            } else {
                e.target.innerText = "Play MIDI";
                e.target.className = "bg-green-600 text-white text-[10px] px-6 py-2 rounded-full font-bold uppercase shadow-sm active:scale-95";
                clearTimeout(timerId);
                document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('current-step'));
            }
        });

        // --- RECORDING LOGIC ---
        const recordBtn = document.getElementById('record-btn');
        const playPreview = document.getElementById('play-preview');
        
        recordBtn.addEventListener('click', async () => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                recordBtn.classList.remove('recording-active');
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    recordedAudioUrl = URL.createObjectURL(audioBlob);
                    playPreview.classList.remove('hidden');
                    playPreview.classList.add('flex');
                    document.getElementById('status').innerText = "Sound ready!";
                };
                mediaRecorder.start();
                recordBtn.classList.add('recording-active');
            } catch(e) { document.getElementById('status').innerText = "Check Mic Settings"; }
        });

        playPreview.onclick = () => { if(recordedAudioUrl) new Audio(recordedAudioUrl).play(); };

        function changeSlot(amt) {
            const input = document.getElementById('slot-number');
            let val = parseInt(input.value) + amt;
            if (val < 0) val = 99;
            if (val > 99) val = 0;
            input.value = val;
        }

        // --- TRANSFER ACTIONS ---
        document.getElementById('pattern-transfer-btn').onclick = () => {
            const pNum = document.getElementById('pattern-slot').value;
            const status = document.getElementById('status');
            status.innerText = `ðŸ”Š Encoding Pattern ${pNum}...`;
            status.className = "text-center text-[9px] font-bold text-orange-500 animate-pulse uppercase";
            
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(14000, ctx.currentTime);
            osc.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 3);

            setTimeout(() => {
                status.innerText = `âœ… Pattern ${pNum} Sent!`;
                status.className = "text-center text-[9px] font-bold text-green-600 uppercase";
            }, 3000);
        };

        document.getElementById('transfer-btn').addEventListener('click', () => {
            const slot = document.getElementById('slot-number').value;
            const status = document.getElementById('status');
            status.innerText = `ðŸ”Š Sending Sound to Slot ${slot}...`;
            setTimeout(() => { status.innerText = `âœ… Uploaded to Slot ${slot}!`; }, 3000);
        });

    </script>
</body>
</html>
